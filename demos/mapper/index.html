<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR Input Inspector</title>
    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --text: #e0e0e0;
            --accent: #00ff9d;
            --warn: #ffb86c;
            --err: #ff5555;
        }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }
        h1, h2 { margin-top: 0; color: var(--accent); }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 90vh;
        }
        .panel {
            background: var(--panel);
            padding: 15px;
            border-radius: 8px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .device-card {
            background: #2a2a2a;
            border-left: 4px solid var(--accent);
            padding: 10px;
            margin-bottom: 15px;
        }
        .axis-row {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        .axis-label { width: 60px; font-size: 12px; }
        .axis-track {
            flex-grow: 1;
            background: #444;
            height: 10px;
            position: relative;
        }
        .axis-fill {
            background: var(--accent);
            height: 100%;
            width: 50%; /* center is default */
            transition: width 0.05s;
        }
        .axis-val { width: 50px; text-align: right; font-size: 11px; margin-left: 5px;}
        
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
            gap: 5px;
            margin-top: 10px;
        }
        .btn-indicator {
            background: #333;
            text-align: center;
            padding: 4px;
            border-radius: 3px;
            font-size: 10px;
        }
        .btn-indicator.active {
            background: var(--accent);
            color: #000;
            font-weight: bold;
        }
        button.action-btn {
            background: var(--accent);
            border: none;
            color: #000;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            width: 100%;
        }
        #log-output {
            width: 100%;
            height: 200px;
            background: #000;
            color: #fff;
            font-family: monospace;
            border: 1px solid #444;
            margin-top: 10px;
        }
        .status-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
        }
        .tag-gamepad { background: #444; border: 1px solid #888; }
        .tag-hid { background: #2b4; color: #000; }
        .tag-err { background: var(--err); color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <!-- Left Panel: Real-time Visualizer -->
    <div class="panel">
        <h2>Live Input Monitor</h2>
        <div id="api-status">Checking APIs...</div>
        <hr style="border-color: #333">
        <div id="device-container">
            <!-- Devices injected here -->
            <div style="color: #666; padding: 20px;">Waiting for user input... Press buttons on your controller.</div>
        </div>
    </div>

    <!-- Right Panel: Data Logging -->
    <div class="panel">
        <h2>Snapshot & Debug</h2>
        <p>Instructions: Move your flight stick/throttle, then click "Capture Snapshot". Copy the JSON below.</p>
        
        <button class="action-btn" onclick="captureSnapshot()">CAPTURE SNAPSHOT</button>
        <button class="action-btn" style="background:var(--warn)" onclick="requestHID()">ATTEMPT WEBHID REQUEST</button>
        
        <textarea id="log-output" readonly placeholder="Snapshot data will appear here..."></textarea>
        <button onclick="copyToClipboard()" style="margin-top:5px; padding:5px;">Copy to Clipboard</button>
        
        <h3>System Info</h3>
        <div id="sys-info" style="font-size: 12px; line-height: 1.5;"></div>
    </div>
</div>

<script>
    const deviceContainer = document.getElementById('device-container');
    const logOutput = document.getElementById('log-output');
    const sysInfo = document.getElementById('sys-info');

    // System Diagnostics
    function checkSystem() {
        const ua = navigator.userAgent;
        const hasGamepad = 'getGamepads' in navigator;
        const hasHID = 'hid' in navigator;
        
        document.getElementById('api-status').innerHTML = `
            Gamepad API: ${hasGamepad ? '<span style="color:#0f0">ACTIVE</span>' : '<span style="color:red">MISSING</span>'} <br>
            WebHID API: ${hasHID ? '<span style="color:#0f0">AVAILABLE</span>' : '<span style="color:red">UNSUPPORTED</span>'}
        `;

        sysInfo.innerHTML = `
            UserAgent: ${ua}<br>
            Platform: ${navigator.platform}<br>
            SecureContext: ${window.isSecureContext ? 'Yes' : 'No'}
        `;
    }

    // Main Loop
    function update() {
        const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
        let html = '';
        let devicesFound = false;

        for (let i = 0; i < gamepads.length; i++) {
            const gp = gamepads[i];
            if (gp) {
                devicesFound = true;
                html += renderGamepad(gp, i);
            }
        }

        if (devicesFound) {
            deviceContainer.innerHTML = html;
        } else {
            deviceContainer.innerHTML = '<div style="color: #666; padding: 20px;">No Gamepads Detected. Press a button to wake device.</div>';
        }

        requestAnimationFrame(update);
    }

    function renderGamepad(gp, index) {
        // Render Axes
        let axesHtml = '';
        gp.axes.forEach((val, idx) => {
            // Visualize -1 to 1 mapped to 0% to 100% width
            const percent = ((val + 1) / 2) * 100;
            const color = Math.abs(val) > 0.1 ? 'var(--accent)' : '#444';
            axesHtml += `
                <div class="axis-row">
                    <div class="axis-label">AXIS ${idx}</div>
                    <div class="axis-track">
                        <div class="axis-fill" style="width: ${percent}%; background: ${color}"></div>
                    </div>
                    <div class="axis-val">${val.toFixed(2)}</div>
                </div>
            `;
        });

        // Render Buttons
        let btnsHtml = '<div class="btn-grid">';
        gp.buttons.forEach((btn, idx) => {
            const activeClass = btn.pressed ? 'active' : '';
            const val = btn.value > 0 ? `(${btn.value.toFixed(1)})` : '';
            btnsHtml += `<div class="btn-indicator ${activeClass}">${idx} ${val}</div>`;
        });
        btnsHtml += '</div>';

        return `
            <div class="device-card">
                <div><span class="status-tag tag-gamepad">GAMEPAD API</span> <strong>Index: ${index}</strong></div>
                <div style="font-size: 11px; margin-bottom: 10px; color: #888;">${gp.id}</div>
                <div style="margin-bottom: 10px;"><strong>Axes:</strong> ${axesHtml}</div>
                <div><strong>Buttons:</strong> ${btnsHtml}</div>
            </div>
        `;
    }

    // Logic to capture a snapshot of current state
    function captureSnapshot() {
        const data = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            gamepads: []
        };

        const gps = navigator.getGamepads();
        for (let i = 0; i < gps.length; i++) {
            const gp = gps[i];
            if(gp) {
                data.gamepads.push({
                    index: gp.index,
                    id: gp.id,
                    mapping: gp.mapping,
                    axes: gp.axes, // Snapshot of current values
                    buttons: gp.buttons.map(b => ({ pressed: b.pressed, value: b.value }))
                });
            }
        }

        logOutput.value = JSON.stringify(data, null, 2);
    }

    // WebHID Request Handler
    async function requestHID() {
        if (!navigator.hid) {
            alert("WebHID API is not supported in this browser.");
            return;
        }

        try {
            const devices = await navigator.hid.requestDevice({ filters: [] });
            if (devices.length > 0) {
                logOutput.value = `SUCCESS: WebHID permission granted for:\n${devices[0].productName}\nVendor: ${devices[0].vendorId}\nProduct: ${devices[0].productId}`;
                
                // Try to listen to input report
                devices[0].open().then(() => {
                   devices[0].addEventListener("inputreport", event => {
                       console.log(event); // Log to console for deep debugging
                   });
                });
            }
        } catch (e) {
            logOutput.value = `ERROR: WebHID Request Failed.\n${e.name}: ${e.message}\n\nNote: Quest Browser often blocks this unless specific experimental flags are enabled.`;
        }
    }

    function copyToClipboard() {
        logOutput.select();
        document.execCommand('copy');
        alert("Copied to clipboard!");
    }

    // Start
    checkSystem();
    requestAnimationFrame(update);

</script>
</body>
</html>