<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Calibrator v4 - Event Logger</title>
    <style>
        :root {
            --bg: #000000;
            --panel: #111;
            --text: #eee;
            --accent: #00ff00;
            --highlight: #ccff00;
            --dim: #555;
            --border: #333;
        }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            padding: 10px;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 10px;
        }
        h1 { margin:0; font-size: 18px; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; }

        /* Main Split */
        .workspace {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            flex-grow: 1;
            overflow: hidden;
        }

        /* Panels */
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-head {
            background: #222;
            padding: 8px;
            font-size: 12px;
            font-weight: bold;
            border-bottom: 1px solid var(--border);
            color: var(--accent);
            display: flex; justify-content: space-between;
        }
        .panel-body {
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* Device Cards */
        .device-card {
            margin-bottom: 15px;
            border: 1px solid var(--dim);
            padding: 8px;
        }
        .dev-header {
            font-weight: bold; color: #fff; margin-bottom: 5px; font-size: 12px;
            border-bottom: 1px solid #333; padding-bottom: 4px;
        }
        .dev-stats { font-size: 10px; color: #888; margin-bottom: 8px; }

        /* Axis Bars */
        .axis-row { display: flex; align-items: center; font-size: 10px; margin-bottom: 2px; }
        .axis-idx { width: 30px; color: #888; }
        .axis-track { flex-grow: 1; height: 10px; background: #333; margin: 0 5px; position: relative; }
        .axis-fill { height: 100%; background: var(--accent); position: absolute; }
        .axis-val { width: 35px; text-align: right; color: #fff; }

        /* Button Grid */
        .btn-grid { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 5px; }
        .btn-cell {
            width: 20px; height: 15px; background: #333; font-size: 9px;
            display: flex; align-items: center; justify-content: center; color: #888;
        }
        .btn-cell.active { background: var(--highlight); color: #000; font-weight: bold; }

        /* Event Log */
        .log-entry {
            font-size: 11px;
            padding: 3px 0;
            border-bottom: 1px solid #222;
            display: flex;
        }
        .log-time { color: #666; width: 60px; }
        .log-dev { color: var(--accent); width: 40px; }
        .log-msg { color: #fff; flex-grow: 1; }
        .log-val { color: var(--highlight); width: 50px; text-align: right; }

    </style>
</head>
<body>

<header>
    <h1>Input Diagnostics</h1>
    <div style="font-size: 10px; color: #888;">QUEST DEBUGGER</div>
</header>

<div class="workspace">
    <!-- LEFT: STATE INSPECTOR -->
    <div class="panel">
        <div class="panel-head">
            <span>LIVE STATE</span>
            <span id="dev-count">Scanning...</span>
        </div>
        <div class="panel-body" id="state-container"></div>
    </div>

    <!-- RIGHT: EVENT LOG -->
    <div class="panel">
        <div class="panel-head">
            <span>CHANGE LOG (MOVE RUDDER NOW)</span>
            <button onclick="logger.clear()" style="background:#333; border:none; color:#fff; cursor:pointer;">Clear</button>
        </div>
        <div class="panel-body" id="log-container">
            <div style="color:#666; font-style:italic;">Waiting for input changes...</div>
        </div>
    </div>
</div>

<script>
class Diagnostics {
    constructor() {
        this.cache = {}; // Store previous values to detect changes
        this.devices = [];
        this.logEl = document.getElementById('log-container');
        this.loop();
    }

    loop() {
        requestAnimationFrame(() => this.loop());
        
        const gps = navigator.getGamepads ? navigator.getGamepads() : [];
        this.devices = [];
        
        // Scan
        for(let i=0; i<gps.length; i++) {
            const gp = gps[i];
            if(gp) {
                this.devices.push(gp);
                this.analyze(gp);
            }
        }
        
        this.renderState();
    }

    analyze(gp) {
        // Check Axes
        gp.axes.forEach((val, idx) => {
            const id = `ax_${gp.index}_${idx}`;
            const prev = this.cache[id];
            
            // Initial load
            if (prev === undefined) {
                this.cache[id] = val;
                return;
            }

            // Check Delta (Significant change)
            if (Math.abs(val - prev) > 0.05) {
                this.log(gp.index, `Axis ${idx}`, val.toFixed(3));
                this.cache[id] = val;
            }
        });

        // Check Buttons
        gp.buttons.forEach((btn, idx) => {
            const id = `btn_${gp.index}_${idx}`;
            const prev = this.cache[id];
            const val = btn.value;

            if (prev === undefined) {
                this.cache[id] = val;
                return;
            }

            if (Math.abs(val - prev) > 0.1) {
                const type = btn.pressed ? "BTN DOWN" : "BTN UP";
                this.log(gp.index, `${type} ${idx}`, val.toFixed(2));
                this.cache[id] = val;
            }
        });
    }

    log(devIdx, msg, val) {
        const div = document.createElement('div');
        div.className = 'log-entry';
        const time = new Date().toLocaleTimeString().split(' ')[0];
        div.innerHTML = `
            <span class="log-time">${time}</span>
            <span class="log-dev">GP${devIdx}</span>
            <span class="log-msg">${msg}</span>
            <span class="log-val">${val}</span>
        `;
        this.logEl.insertBefore(div, this.logEl.firstChild);
        
        // Keep log clean
        if(this.logEl.children.length > 50) {
            this.logEl.removeChild(this.logEl.lastChild);
        }
    }

    clear() {
        this.logEl.innerHTML = '';
    }

    renderState() {
        const c = document.getElementById('state-container');
        document.getElementById('dev-count').innerText = `${this.devices.length} Devices`;

        if (this.devices.length === 0) {
            c.innerHTML = `<div style="padding:20px; color:#444;">No Gamepads Detected.<br>Press buttons to wake.</div>`;
            return;
        }

        // Optimized Render: Just build HTML string
        let html = '';
        this.devices.forEach(gp => {
            const shortId = gp.id.length > 25 ? gp.id.substring(0, 25) + '...' : gp.id;
            
            let axesHtml = '';
            gp.axes.forEach((val, idx) => {
                const pct = ((val + 1) / 2) * 100;
                axesHtml += `
                    <div class="axis-row">
                        <span class="axis-idx">${idx}</span>
                        <div class="axis-track">
                            <div class="axis-fill" style="width:${pct}%"></div>
                        </div>
                        <span class="axis-val">${val.toFixed(2)}</span>
                    </div>`;
            });

            let btnsHtml = '<div class="btn-grid">';
            gp.buttons.forEach((btn, idx) => {
                const cls = btn.pressed ? 'btn-cell active' : 'btn-cell';
                btnsHtml += `<div class="${cls}">${idx}</div>`;
            });
            btnsHtml += '</div>';

            html += `
                <div class="device-card">
                    <div class="dev-header">${shortId}</div>
                    <div class="dev-stats">Index: ${gp.index} | Mapping: "${gp.mapping}" | <strong>Axes: ${gp.axes.length}</strong> | Buttons: ${gp.buttons.length}</div>
                    ${axesHtml}
                    ${btnsHtml}
                </div>
            `;
        });
        c.innerHTML = html;
    }
}

window.logger = new Diagnostics();
</script>
</body>
</html>